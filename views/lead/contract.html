<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Contracts (동적 month + ownerDept)</title>

  <!-- Third-party styles -->
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.14/themes/redmond/jquery-ui.css" type="text/css" />
  <link rel="stylesheet" href="//cdn.jsdelivr.net/jqgrid/4.6.0/css/ui.jqgrid.css" type="text/css" />

  <!-- Shared styles -->
  <link rel="stylesheet" href="/cs/static/assets/common.css" type="text/css" />

  <style>
    .toolbar {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .toolbar label {
      font-size: 14px;
      color: #333;
    }

    .toolbar input[type="month"],
    .toolbar select {
      padding: 6px 8px;
    }

    .toolbar button {
      padding: 6px 10px;
      cursor: pointer;
    }

    .detail-row-products td,
    .detail-row-promotions td {
      background: #fafafa;
      padding: 12px 16px !important;
    }

    .detail-wrap {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px;
    }

    .detail-title {
      margin: 0 0 8px;
      font-weight: 700;
    }

    .detail-table {
      width: 100%;
      border-collapse: collapse;
    }

    .detail-table th,
    .detail-table td {
      border-bottom: 1px solid #eee;
      padding: 6px 8px;
      text-align: right;
    }

    .detail-table th:nth-child(1),
    .detail-table td:nth-child(1),
    .detail-table th:nth-child(2),
    .detail-table td:nth-child(2) {
      text-align: left;
    }

    .clickable {
      color: #1565c0;
      text-decoration: underline;
      cursor: pointer;
    }

    .highlight-col {
      background-color: #fff8b3;
      font-weight: bold;
    }

    .highlight2-col {
      background-color: #e6fff0;
      font-weight: bold;
    }

    .kpi-bar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .kpi-item {
      background: #f5f8ff;
      border: 1px solid #d7e3ff;
      border-radius: 6px;
      padding: 8px 12px;
      min-width: 150px;
    }

    .kpi-item__label {
      display: block;
      font-size: 12px;
      color: #5b6b82;
      margin-bottom: 4px;
    }

    .kpi-item__value {
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
    }

    .ui-jqgrid-btable tr.row-not-closed td {
      background-color: #ffecec !important;
    }

    .ui-jqgrid-btable tr.row-not-current-month td {
      background-color: #e6e6e6 !important;
    }
    main.content {
      position: relative;
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <h1 class="sidebar__title">Salesforce 리포트</h1>
      <p class="sidebar__subtitle">계약 현황 분석</p>
      <nav class="sidebar__nav">
        <a href="/cs/lead/dashboard">월간 리드 현황</a>
        <a href="/cs/lead/dashboard/daily">일자별 리드</a>
        <a href="/cs/lead/insights">전환 인사이트</a>
        <a href="/cs/lead/contracts">계약 현황</a>
        <a href="/cs/lead/tasks/outbound-sensitivity">감도 Task 모니터링</a>
        <a href="/cs/opportunity/kanban">영업기회 칸반</a>
      </nav>
    </aside>

    <main class="content">
      <div class="page-header">
        <h2 class="page-header__title">계약 현황 분석</h2>
        <p class="page-header__desc">월별 계약 데이터를 담당자/부서/레코드 타입 기준으로 비교하세요.</p>
      </div>

      <div class="toolbar">
        <label for="month">월 선택:</label>
        <input type="month" id="month" />
        <label for="groupBy">그룹 기준:</label>
        <select id="groupBy">
          <option value="ownerNameFlat">담당자</option>
          <option value="FieldUser">필드담당자</option>
          <option value="BOUser">BO 담당자</option>
          <option value="ownerDeptFlat">부서</option>
          <option value="leadSource">리드 소스</option>
          <option value="recordTypeName">레코드 타입</option>
        </select>
        <label for="ownerDept">부서:</label>
        <select id="ownerDept">
          <option value="">전체</option>
          <option value="아웃바운드세일즈">아웃바운드세일즈</option>
          <option value="인바운드세일즈">인바운드세일즈</option>
          <option value="채널세일즈팀">채널세일즈팀</option>
          <option value="리텐션">리텐션</option>
        </select>

        <button id="prevBtn">◀ 이전달</button>
        <button id="nextBtn">다음달 ▶</button>
        <button id="loadBtn">불러오기</button>
        <button id="expandGroupsBtn">그룹 모두 펼치기</button>
        <button id="collapseGroupsBtn">그룹 모두 접기</button>
        <span id="title" style="margin-left:auto;font-weight:600;"></span>
      </div>

      <div id="kpiBar" class="kpi-bar"></div>

      <table id="contracts"></table>
      <div id="contracts-pager"></div>
    </main>
  </div>

  <!-- Third-party scripts -->
  <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
  <script src="https://code.jquery.com/ui/1.10.3/jquery-ui.min.js"></script>
  <script src="//cdn.jsdelivr.net/jqgrid/4.6.0/i18n/grid.locale-kr.js"></script>
  <script src="//cdn.jsdelivr.net/jqgrid/4.6.0/jquery.jqGrid.src.js"></script>

  <!-- Shared helpers -->
  <script src="/cs/static/assets/gridCommon.js"></script>

  <script>
    $.jgrid = $.jgrid || {}; $.jgrid.no_legacy_api = true; $.jgrid.useJSON = true;

    const GC = window.gridCommon || {};
    if (GC.highlightActiveNav) GC.highlightActiveNav(".sidebar__nav");
    const API_BASE = GC.API_BASE || "/cs/api";

    function fmt(value) {
      const num = Number(value || 0);
      return Number.isFinite(num) ? num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : "";
    }

    function labelKorean(ym) {
      if (!ym) return "";
      const parts = ym.split("-");
      return parts[0] + "년 " + Number(parts[1]) + "월";
    }

    function addMonths(ym, delta) {
      const parts = ym.split("-").map(Number);
      const date = new Date(Date.UTC(parts[0], parts[1] - 1, 1));
      date.setUTCMonth(date.getUTCMonth() + delta);
      return date.toISOString().slice(0, 7);
    }

    function sumField(rows, field) {
      return rows.reduce((acc, row) => {
        const value = Number(row ? row[field] : NaN);
        return Number.isFinite(value) ? acc + value : acc;
      }, 0);
    }

    function calcAvg(rows, field) {
      const list = rows.map((row) => Number(row[field])).filter((v) => Number.isFinite(v));
      if (!list.length) return null;
      return list.reduce((a, b) => a + b, 0) / list.length;
    }

    function formatDays(value) {
      return Number.isFinite(value) && value > 0 ? value.toFixed(1) + "일" : "-";
    }

    function toggleAllGroups(expand) {
      const grid = $("#contracts")[0];
      const $table = grid?.grid?.bDiv
        ? $(grid.grid.bDiv).find("table.ui-jqgrid-btable")
        : $("#contracts");
      $table.find("tr.jqgroup").each(function () {
        const $icon = $("span.ui-icon", this);
        const isCollapsed = $icon.hasClass("ui-icon-circlesmall-plus");
        const isExpanded = $icon.hasClass("ui-icon-circlesmall-minus");
        if (expand && isCollapsed) $icon.trigger("click");
        if (!expand && isExpanded) $icon.trigger("click");
      });
    }

    function resizeMainGrid() {
      const $grid = $("#contracts");
      if (!$grid.length || !$grid[0].grid) return;
      const top = $grid.offset()?.top || 0;
      const viewHeight = window.innerHeight || $(window).height() || 0;
      const height = Math.max(240, viewHeight - top - 40);
      try {
        $grid.jqGrid("setGridHeight", height);
      } catch (err) {
        console.warn("jqGrid setGridHeight failed", err);
      }
      const $wrapper = $grid.closest(".ui-jqgrid").parent();
      const width = $wrapper.width();
      if (width) {
        try {
          $grid.jqGrid("setGridWidth", width);
        } catch (err2) {
          console.warn("jqGrid setGridWidth failed", err2);
        }
      }
    }

    function renderProductsHTML(products) {
      const rows = Array.isArray(products) ? products : [];
      let html =
        '<div class="detail-wrap"><p class="detail-title">Products 상세</p>' +
        '<table class="detail-table"><thead><tr>' +
        '<th>Product Id</th><th>제품군</th><th>수량</th><th>기준단가</th><th>실단가</th><th>옵션</th><th>라인합계</th>' +
        "</tr></thead><tbody>";
      rows.forEach((p) => {
        const qty = Number(p?.quantity || 0);
        const unit = Number(p?.totalPrice || 0);
        const opt =
          Array.isArray(p?.option) && p.option[0]?.hasOption
            ? "+" + fmt(p.option[0].optionExtraTotal) + "/ea"
            : "";
        html +=
          "<tr>" +
          "<td>" + (p?.id || "") + "</td>" +
          "<td>" + (p?.family || "") + "</td>" +
          "<td>" + fmt(qty) + "</td>" +
          "<td>" + fmt(p?.unitPrice) + "</td>" +
          "<td>" + fmt(unit) + "</td>" +
          '<td style="text-align:left">' + opt + "</td>" +
          "<td>" + fmt(qty * unit) + "</td>" +
          "</tr>";
      });
      html += "</tbody></table></div>";
      return html;
    }

    function renderPromotionsHTML(promotions) {
      const rows = Array.isArray(promotions) ? promotions : [];
      let html =
        '<div class="detail-wrap"><p class="detail-title">Promotions 상세</p>' +
        '<table class="detail-table"><thead><tr>' +
        "<th>Promotion Id</th><th>프로모션명</th><th>금액</th><th>출처</th>" +
        "</tr></thead><tbody>";
      rows.forEach((pr) => {
        html +=
          "<tr>" +
          "<td>" + (pr?.id || "") + "</td>" +
          "<td>" + (pr?.promotionName || "") + "</td>" +
          "<td>" + fmt(pr?.totalAmount) + "</td>" +
          '<td style="text-transform:capitalize">' + (pr?._source || "") + "</td>" +
          "</tr>";
      });
      html += "</tbody></table></div>";
      return html;
    }

    function toggleDetailRow(rowId, rows, type) {
      const $grid = $("#contracts");
      let $mainTr = $("#" + rowId, $grid[0].grid && $grid[0].grid.bDiv);
      if (!$mainTr.length) $mainTr = $("#" + $.jgrid.jqID(rowId));
      const cls = type === "products" ? "detail-row-products" : "detail-row-promotions";
      const $next = $mainTr.next("." + cls);
      if ($next.length) {
        $next.remove();
        return;
      }
      const record = rows.find((r) => (r.id || r._id) === rowId) || null;
      const colspan = $mainTr.children("td:visible").length;
      const inner =
        type === "products"
          ? renderProductsHTML(record?.products)
          : renderPromotionsHTML(record?.promotions);
      $('<tr class="' + cls + '"><td colspan="' + colspan + '">' + inner + "</td></tr>").insertAfter($mainTr);
    }

    function updateKpis(rows) {
      const $bar = $("#kpiBar");
      if (!$bar.length) return;
      if (!Array.isArray(rows) || !rows.length) {
        $bar.html(
          '<div class="kpi-item"><span class="kpi-item__label">계약 데이터</span><span class="kpi-item__value">없음</span></div>',
        );
        return;
      }

      const totalContracts = rows.length;
      const totalTablets = sumField(rows, "TotalNumberofEveryTablet__c");
      const totalDiscount = sumField(rows, "totalDiscount");
      const avgLeadToOpp = calcAvg(rows, "leadToOpportunityDays");
      const avgLeadTime = calcAvg(rows, "leadTimeDays");
      const avgInstall = calcAvg(rows, "prevToFirstCloseDays");

      let closedWonContracts = 0;
      let closedWonTablets = 0;
      const closedSet = new Set(["closedwon", "계약완료", "계약 완료"].map((s) => s.replace(/\s+/g, "").toLowerCase()));
      rows.forEach((row) => {
        const stage = String(
          row.stageNameFlat ||
            row.stageName ||
            row.opportunity?.stageName ||
            "",
        )
          .toLowerCase()
          .replace(/\s+/g, "");
        if (closedSet.has(stage)) {
          closedWonContracts += 1;
          const tablets = Number(row.TotalNumberofEveryTablet__c || 0);
          if (Number.isFinite(tablets)) closedWonTablets += tablets;
        }
      });

      const items = [
        { label: "계약 건수", value: totalContracts.toLocaleString("ko-KR") + "건" },
        { label: "총 태블릿", value: fmt(totalTablets) + "대" },
        { label: "총 할인", value: fmt(totalDiscount) + "원" },
        { label: "평균 리드→기회", value: formatDays(avgLeadToOpp) },
        { label: "평균 계약 소요일", value: formatDays(avgLeadTime) },
        { label: "평균 설치 확정", value: formatDays(avgInstall) },
        { label: "Close Won 건수", value: closedWonContracts.toLocaleString("ko-KR") + "건" },
        { label: "Close Won 태블릿", value: fmt(closedWonTablets) + "대" },
      ];

      $bar.empty();
      items.forEach((item) => {
        $bar.append(
          '<div class="kpi-item">' +
            '<span class="kpi-item__label">' + item.label + "</span>" +
            '<span class="kpi-item__value">' + item.value + "</span>" +
            "</div>",
        );
      });
    }

    function normalizeContracts(raw) {
      return raw.map((contract) => {
        const c = { ...(contract || {}) };
        c.id = c.id || c.sfId || c._id || null;
        c.opportunity = c.opportunity || {};
        c.lead = c.lead || {};

        c.leadCompany = c.lead.company || "";
        c.leadSource = c.lead.leadSource || "";
        c.leadUtm = c.lead.utm || "";
        c.leadUtmSource = c.lead.utmSource || "";
        c.leadUtmContent = c.lead.utmContent || "";
        c.leadUtmTerm = c.lead.utmTerm || "";
        c.leadSourceFlat = c.lead.leadSource || c.leadSourceOpportunity || "";
        c.opportunityLeadSource = c.leadSourceOpportunity || c.opportunity.leadSource || "";

        c.fmSido = c.fmSido || c.opportunity.fmSido || "";
        c.fmSigugun = c.fmSigugun || c.opportunity.fmSigugun || "";
        c.fmStoreType = c.fmStoreType || c.opportunity.fmStoreType || "";
        c.plIndustryFirst = c.plIndustryFirst || c.opportunity.plIndustryFirst || "";
        c.plIndustrySecond = c.plIndustrySecond || c.opportunity.plIndustrySecond || "";
        c.typeOfBusiness = c.typeOfBusiness || c.opportunity.typeOfBusiness || "";
        c.recordTypeName = c.recordTypeName || "(알 수 없음)";
        c.stageNameFlat = c.opportunity.stageName || "";
        c.opportunityCreatedDate = c.opportunity.createdDate || "";
        c.ownerNameFlat = c.opportunity.ownerName || "";
        c.ownerDeptFlat = c.opportunity.ownerDepartment || "";

        c.name = c.name || "";
        c.FieldUser = c.FieldUser || "";
        c.BOUser = c.BOUser || "";
        c.opportunityAccountName = c.opportunity.accountName || "";
        c.opportunityAccountBranchName = c.opportunity.accountBranchName || "";
        c.accountName = c.accountName || "";
        c.accountBranchName = c.accountBranchName || "";
        c.contractDateStart = c.contractDateStart || "";
        c.contractDateEnd = c.contractDateEnd || "";
        c.contractStatus = c.contractStatus || "";

        c.TotalNumberofEveryTablet__c = Number(c.TotalNumberofEveryTablet__c || 0);
        c.productsTotal = Number(c.productsTotal || 0);
        c.promotionsFromProductsTotal = Number(c.promotionsFromProductsTotal || 0);
        c.promotionsNativeTotal = Number(c.promotionsNativeTotal || 0);
        c.purchaseAmount = Number(c.purchaseAmount || 0);
        c.vat = Number(c.vat || 0);
        c.totalWithVat = Number(c.totalWithVat || 0);
        c.totalDiscount = Number(c.totalDiscount || 0);

        c.products = Array.isArray(c.products) ? c.products : [];
        c.promotions = Array.isArray(c.promotions) ? c.promotions : [];

        c.leadToOpportunityDays = Number.isFinite(c.leadToOpportunity?.days) ? c.leadToOpportunity.days : null;
        c.leadToOpportunityReason = c.leadToOpportunity?.reason || null;
        c.leadTimeDays = Number.isFinite(c.leadTime?.days) ? c.leadTime.days : null;
        c.leadTimeReason = c.leadTime?.reason || null;
        c.prevToFirstCloseDays = Number.isFinite(c.prevToFirstClose?.days) ? c.prevToFirstClose.days : null;
        c.prevToFirstCloseReason = c.prevToFirstClose?.reason || null;

        return c;
      });
    }

    let currentGroupField = "ownerNameFlat";

    function buildGrid(rows) {
      if ($("#contracts")[0].grid) $("#contracts").GridUnload();

      const groupLabels = {
        ownerNameFlat: "담당자",
        FieldUser: "필드담당자",
        BOUser: "BO 담당자",
        ownerDeptFlat: "부서",
        recordTypeName: "레코드 타입",
        leadSourceFlat: "리드 소스",
      };

      const leadToOppAvg = calcAvg(rows, "leadToOpportunityDays");
      const leadTimeAvg = calcAvg(rows, "leadTimeDays");
      const installAvg = calcAvg(rows, "prevToFirstCloseDays");

      $("#contracts").jqGrid({
        datatype: "local",
        data: rows,
        colNames: [
          "d", "Opp 생성일(원본)", "Contract Id", "리드 Company", "리드 소스", "리드 UTM", "UTM Source", "UTM Content",
          "UTM Term", "기회 고객명", "기회 지점명", "업종(대)", "업종(중)", "업태", "기회 리드 소스", "시/도", "시/군/구",
          "매장 유형", "리드→기회(일)", "계약 소요일", "설치 확정 소요일", "레코드유형", "필드담당자", "BO 담당자",
          "상호명", "지점명", "상태", "계약시작일", "계약종료일", "담당자", "계약태블릿수", "상품합계", "상품할인합계",
          "구매가", "부가세", "합계(부가세포함)", "네이티브프로모션", "총할인", "부서",
        ],
        colModel: [
          { name: "stageNameFlat", hidden: true },
          { name: "opportunityCreatedDate", hidden: true },
          { name: "id", width: 130, key: true, hidden: true },
          { name: "leadCompany", width: 80 },
          { name: "leadSource", width: 80, align: "center" },
          { name: "leadUtm", width: 110, align: "center" },
          { name: "leadUtmSource", width: 110, align: "center" },
          { name: "leadUtmContent", width: 140, align: "center" },
          { name: "leadUtmTerm", width: 120, align: "center" },
          { name: "opportunityAccountName", width: 120, align: "center" },
          { name: "opportunityAccountBranchName", width: 110, align: "center" },
          { name: "plIndustryFirst", width: 100, align: "center" },
          { name: "plIndustrySecond", width: 110, align: "center" },
          { name: "typeOfBusiness", width: 90, align: "center" },
          { name: "opportunityLeadSource", width: 100, align: "center" },
          { name: "fmSido", width: 80, align: "center" },
          { name: "fmSigugun", width: 90, align: "center" },
          { name: "fmStoreType", width: 100, align: "center" },
          {
            name: "leadToOpportunityDays",
            width: 80,
            align: "right",
            sorttype: "number",
            formatter: function (cell, opts, row) {
              if (Number.isFinite(cell)) {
                let color = "";
                if (leadToOppAvg != null) {
                  if (cell > leadToOppAvg) color = "red";
                  else if (cell < leadToOppAvg) color = "blue";
                }
                return '<span title="평균: ' + (leadToOppAvg?.toFixed?.(1) ?? "-") + '" style="color:' + color + '">' +
                  cell.toLocaleString() + "</span>";
              }
              if (row.leadToOpportunityReason === "missing-date") return '<span title="날짜 없음">—</span>';
              if (row.leadToOpportunityReason === "parse-error") return '<span title="파싱 오류">!</span>';
              return "";
            },
            summaryType: "avg",
          },
          {
            name: "leadTimeDays",
            width: 80,
            align: "right",
            sorttype: "number",
            formatter: function (cell, opts, row) {
              if (row.leadTimeReason === "missing-date") return '<span title="날짜 없음">날짜 없음</span>';
              if (row.leadTimeReason === "parse-error") return '<span title="날짜 파싱 오류">!</span>';
              if (!Number.isFinite(cell)) return "";
              let color = "";
              if (leadTimeAvg != null) {
                if (cell > leadTimeAvg) color = "red";
                else if (cell < leadTimeAvg) color = "blue";
              }
              return '<span style="color:' + color + '">' + cell.toLocaleString() + "</span>";
            },
            summaryType: "avg",
          },
          {
            name: "prevToFirstCloseDays",
            width: 80,
            align: "right",
            sorttype: "number",
            formatter: function (cell, opts, row) {
              if (row.prevToFirstCloseReason === "missing-date") return '<span title="날짜 없음">날짜 없음</span>';
              if (row.prevToFirstCloseReason === "parse-error") return '<span title="날짜 파싱 오류">!</span>';
              if (!Number.isFinite(cell)) return "";
              let color = "";
              if (installAvg != null) {
                if (cell > installAvg) color = "red";
                else if (cell < installAvg) color = "blue";
              }
              return '<span style="color:' + color + '">' + cell.toLocaleString() + "</span>";
            },
            summaryType: "avg",
          },
          { name: "recordTypeName", width: 140, align: "center" },
          { name: "FieldUser", width: 80, align: "center" },
          { name: "BOUser", width: 80, align: "center" },
          { name: "accountName", width: 100, align: "center" },
          { name: "accountBranchName", width: 80, align: "center" },
          { name: "contractStatus", width: 110, align: "center" },
          { name: "contractDateStart", width: 100, align: "center" },
          { name: "contractDateEnd", width: 100, align: "center" },
          { name: "ownerNameFlat", width: 90, align: "center" },
          {
            name: "TotalNumberofEveryTablet__c",
            width: 110,
            align: "right",
            formatter: "number",
            formatoptions: { thousandsSeparator: ",", decimalPlaces: 0 },
            summaryType: "sum",
            summaryTpl: "태블릿 합계: {0}",
            classes: "highlight-col",
          },
          {
            name: "productsTotal",
            width: 120,
            align: "right",
            formatter: function (cell, opts, row) {
              const val = fmt(cell);
              return '<a href="#" class="clickable prod-toggle" data-rowid="' + (row.id || opts.rowId) + '">' + val + "</a>";
            },
            summaryType: "sum",
          },
          {
            name: "promotionsFromProductsTotal",
            width: 130,
            align: "right",
            formatter: "number",
            formatoptions: { thousandsSeparator: ",", decimalPlaces: 0 },
            summaryType: "sum",
          },
          {
            name: "purchaseAmount",
            width: 130,
            align: "right",
            formatter: "number",
            formatoptions: { thousandsSeparator: ",", decimalPlaces: 0 },
            summaryType: "sum",
          },
          {
            name: "vat",
            width: 90,
            align: "right",
            formatter: "number",
            formatoptions: { thousandsSeparator: ",", decimalPlaces: 0 },
            summaryType: "sum",
          },
          {
            name: "totalWithVat",
            width: 120,
            align: "right",
            formatter: "number",
            formatoptions: { thousandsSeparator: ",", decimalPlaces: 0 },
            summaryType: "sum",
            classes: "highlight2-col",
          },
          {
            name: "promotionsNativeTotal",
            width: 120,
            align: "right",
            formatter: "number",
            formatoptions: { thousandsSeparator: ",", decimalPlaces: 0 },
            summaryType: "sum",
          },
          {
            name: "totalDiscount",
            width: 120,
            align: "right",
            formatter: function (cell, opts, row) {
              const val = fmt(cell);
              return '<a href="#" class="clickable promo-toggle" data-rowid="' + (row.id || opts.rowId) + '">' + val + "</a>";
            },
            summaryType: "sum",
          },
          { name: "ownerDeptFlat", hidden: true },
        ],
        pager: "#contracts-pager",
        rowNum: 1000,
        rowList: [20, 50, 1000],
        viewrecords: true,
        autowidth: true,
        shrinkToFit: false,
        height: 420,
        grouping: true,
        groupingView: {
          groupField: [currentGroupField],
          groupColumnShow: [true],
          groupText: [groupLabels[currentGroupField] + ": <b>{0}</b> <span style='color:#888'>( {1} 건 )</span>"],
          groupOrder: ["asc"],
          groupSummary: [true],
          groupSummaryPos: ["footer"],
        },
        footerrow: true,
        userDataOnFooter: true,
        loadComplete: function () {
          const $grid = $("#contracts");
          const ids = $grid.jqGrid("getDataIDs");
          const norm = (s) => String(s || "").toLowerCase().replace(/\s+/g, "");
          const closedWonSet = new Set(["closedwon", "계약완료", "계약 완료"].map(norm));
          ids.forEach((id) => {
            const stage = $grid.jqGrid("getCell", id, "stageNameFlat");
            const createdDate = $grid.jqGrid("getCell", id, "opportunityCreatedDate");
            if (!closedWonSet.has(norm(stage))) $("#" + $.jgrid.jqID(id)).addClass("row-not-closed");
            if (!isSelectedMonth(createdDate)) $("#" + $.jgrid.jqID(id)).addClass("row-not-current-month");
          });

          const totalTablets = $grid.jqGrid("getCol", "TotalNumberofEveryTablet__c", false, "sum");
          $grid.jqGrid("footerData", "set", {
            ownerNameFlat: "총 합계",
            TotalNumberofEveryTablet__c: totalTablets,
          });
          resizeMainGrid();
        },
      });

      $("#contracts").jqGrid("setGroupHeaders", {
        useColSpanStyle: true,
        groupHeaders: [
          { startColumnName: "leadCompany", numberOfColumns: 6, titleText: "<span>리드 정보</span>" },
          { startColumnName: "opportunityAccountName", numberOfColumns: 5, titleText: "<span>고객 정보</span>" },
          { startColumnName: "opportunityLeadSource", numberOfColumns: 10, titleText: "<span>영업 기회 정보</span>" },
          { startColumnName: "accountName", numberOfColumns: 14, titleText: "<span>계약 정보</span>" },
        ],
      });

      $("#contracts")
        .off("click", ".prod-toggle")
        .on("click", ".prod-toggle", function (e) {
          e.preventDefault();
          toggleDetailRow($(this).data("rowid"), rows, "products");
        });

      $("#contracts")
        .off("click", ".promo-toggle")
        .on("click", ".promo-toggle", function (e) {
          e.preventDefault();
          toggleDetailRow($(this).data("rowid"), rows, "promotions");
        });
    }

    function isSelectedMonth(dateStr) {
      if (!dateStr) return false;
      const current = $("#month").val();
      if (!current) return false;
      return dateStr.slice(0, 7) === current;
    }

    function updateTitle(rows, ym, dept) {
      const totalContracts = rows.length;
      const totalTablets = sumField(rows, "TotalNumberofEveryTablet__c");
      const avgTablets = totalContracts ? (totalTablets / totalContracts).toFixed(1) : "0.0";
      $("#title").text(
        labelKorean(ym) +
          (dept ? " / " + dept : " / 전체") +
          " · 계약 " + totalContracts + "건 · 태블릿 합계 " + fmt(totalTablets) + "대 (평균 " + avgTablets + "대)",
      );
    }

    function fetchContracts() {
      const ym = $("#month").val();
      const dept = $("#ownerDept").val();

      $("#title").text("조회: " + labelKorean(ym) + (dept ? " / " + dept : ""));

      const params = { month: ym };
      if (dept) params.ownerDept = dept;

      return $.getJSON(API_BASE + "/contracts", params)
        .then((contracts) => (Array.isArray(contracts) ? contracts : []))
        .catch((err) => {
          console.error("계약 데이터 로딩 실패", err);
          alert("데이터 로딩 실패: " + (err?.status || "unknown"));
          return [];
        });
    }

    function refreshGrid() {
      const ym = $("#month").val();
      const dept = $("#ownerDept").val();
      fetchContracts().then((contracts) => {
        const rows = normalizeContracts(contracts);
        updateKpis(rows);
        buildGrid(rows);
        updateTitle(rows, ym, dept);
      });
    }

    $(function () {
      const today = new Date();
      today.setUTCDate(1);
      $("#month").val(today.toISOString().slice(0, 7));
      $("#ownerDept").val("아웃바운드세일즈");
      currentGroupField = $("#groupBy").val() || "ownerNameFlat";

      $("#loadBtn").on("click", refreshGrid);
      $("#prevBtn").on("click", function () {
        $("#month").val(addMonths($("#month").val(), -1));
        refreshGrid();
      });
      $("#nextBtn").on("click", function () {
        $("#month").val(addMonths($("#month").val(), 1));
        refreshGrid();
      });
      $("#ownerDept").on("change", refreshGrid);
      $("#groupBy").on("change", function () {
        currentGroupField = this.value || "ownerNameFlat";
        refreshGrid();
      });
      $("#expandGroupsBtn").on("click", function () {
        toggleAllGroups(true);
      });
      $("#collapseGroupsBtn").on("click", function () {
        toggleAllGroups(false);
      });
      $(window).on("resize.contractsGrid", resizeMainGrid);

      if (GC.registerGridResize) {
        GC.registerGridResize("#contracts", { bottomOffset: 40 });
      }

      refreshGrid();
    });
  </script>
</body>
</html>
