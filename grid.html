<!doctype html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <title>Contracts (ë™ì  month + ownerDept)</title>

    <!-- jQuery UI theme + jqGrid CSS -->
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.14/themes/redmond/jquery-ui.css"
        type="text/css" />
    <link rel="stylesheet" href="//cdn.jsdelivr.net/jqgrid/4.6.0/css/ui.jqgrid.css" type="text/css" />

    <style>
        html,
        body {
            height: 100%;
        }

        body {
            font-family: Arial, Apple SD Gothic Neo, "ë§‘ì€ ê³ ë”•", sans-serif;
            margin: 20px;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .toolbar label {
            font-size: 14px;
            color: #333;
        }

        .toolbar input[type="month"],
        .toolbar select {
            padding: 6px 8px;
        }

        .toolbar button {
            padding: 6px 10px;
            cursor: pointer;
        }

        .detail-row-products td,
        .detail-row-promotions td {
            background: #fafafa;
            padding: 12px 16px !important;
        }

        .detail-wrap {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
        }

        .detail-title {
            margin: 0 0 8px;
            font-weight: 700;
        }

        .detail-table {
            width: 100%;
            border-collapse: collapse;
        }

        .detail-table th,
        .detail-table td {
            border-bottom: 1px solid #eee;
            padding: 6px 8px;
            text-align: right;
        }

        .detail-table th:nth-child(1),
        .detail-table td:nth-child(1),
        .detail-table th:nth-child(2),
        .detail-table td:nth-child(2) {
            text-align: left;
        }

        .clickable {
            color: #1565c0;
            text-decoration: underline;
            cursor: pointer;
        }

        .highlight-col {
            background-color: #fff8b3;
            font-weight: bold;
        }

        .highlight2-col {
            background-color: #e6fff0;
            font-weight: bold;
        }

        /* Close Won ì´ ì•„ë‹Œ í–‰ ìƒ‰ìƒ */
        .ui-jqgrid-btable tr.row-not-closed td {
            background-color: #ffecec !important;
            /* ì—°í•œ ë¹¨ê°• */
            /* color: #a60000;  í…ìŠ¤íŠ¸ ìƒ‰ìƒ ê°•ì¡° ì›í•˜ë©´ */
        }

        /* ì´ë²ˆ ë‹¬ ìƒì„±ì´ ì•„ë‹Œ ê¸°íšŒ */
        .ui-jqgrid-btable tr.row-not-current-month td {
            background-color: #e6e6e6 !important;
            /* ì—°íšŒìƒ‰ */
        }
    </style>
</head>

<body>
    <div class="toolbar">
        <label for="month">ì›” ì„ íƒ:</label>
        <input type="month" id="month" />
        <label for="groupBy">ê·¸ë£¹ ê¸°ì¤€:</label>
        <select id="groupBy">
            <option value="ownerNameFlat">ë‹´ë‹¹ì</option>
            <option value="FieldUser">í•„ë“œë‹´ë‹¹ì</option>
            <option value="BOUser">BO ë‹´ë‹¹ì</option>
            <option value="ownerDeptFlat">ë¶€ì„œ</option>
            <option value="leadSource">ë¦¬ë“œ ì†ŒìŠ¤</option>
            <option value="recordTypeName">ë ˆì½”ë“œ íƒ€ì…</option>
        </select>
        <label for="ownerDept">ë¶€ì„œ:</label>
        <select id="ownerDept">
            <option value="">ì „ì²´</option>
            <option value="ì•„ì›ƒë°”ìš´ë“œì„¸ì¼ì¦ˆ">ì•„ì›ƒë°”ìš´ë“œì„¸ì¼ì¦ˆ</option>
            <option value="ì¸ë°”ìš´ë“œì„¸ì¼ì¦ˆ">ì¸ë°”ìš´ë“œì„¸ì¼ì¦ˆ</option>
            <option value="ì±„ë„ì„¸ì¼ì¦ˆíŒ€">ì±„ë„ì„¸ì¼ì¦ˆíŒ€</option>
            <option value="ë¦¬í…ì…˜">ë¦¬í…ì…˜</option>
        </select>

        <button id="prevBtn">â—€ ì´ì „ë‹¬</button>
        <button id="nextBtn">ë‹¤ìŒë‹¬ â–¶</button>
        <button id="loadBtn">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button id="expandGroupsBtn">ê·¸ë£¹ ëª¨ë‘ í¼ì¹˜ê¸°</button>
        <button id="collapseGroupsBtn">ê·¸ë£¹ ëª¨ë‘ ì ‘ê¸°</button>
        <span id="title" style="margin-left:auto;font-weight:600;"></span>
    </div>

    <table id="contracts"></table>
    <div id="contracts-pager"></div>

    <!-- jQuery / UI / jqGrid -->
    <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="https://code.jquery.com/ui/1.10.3/jquery-ui.min.js"></script>
    <script src="//cdn.jsdelivr.net/jqgrid/4.6.0/i18n/grid.locale-kr.js"></script>
    <script src="//cdn.jsdelivr.net/jqgrid/4.6.0/jquery.jqGrid.src.js"></script>

    <script>
        $.jgrid = $.jgrid || {}; $.jgrid.no_legacy_api = true; $.jgrid.useJSON = true;

        // ğŸ”§ ì„œë²„ ì£¼ì†Œ
        var API_BASE = "http://localhost:4000";

        // ìˆ«ì ì½¤ë§ˆ
        function fmt(n) { n = Number(n || 0); return isNaN(n) ? "" : n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); }

        // YYYY-MM â‡„ í‘œì‹œ ë¼ë²¨
        function labelKorean(ym) { var a = ym.split("-"); return a[0] + "ë…„ " + Number(a[1]) + "ì›”"; }
        function addMonths(ym, delta) {
            var a = ym.split("-").map(Number); var d = new Date(Date.UTC(a[0], a[1] - 1, 1));
            d.setUTCMonth(d.getUTCMonth() + delta); return d.toISOString().slice(0, 7);
        }
        // ê·¸ë£¹(ë‹´ë‹¹ì) ì „ì²´ í† ê¸€
        function toggleAllGroups(expand) {
            var $btable = $("#contracts")[0].grid && $("#contracts")[0].grid.bDiv
                ? $($("#contracts")[0].grid.bDiv).find("table.ui-jqgrid-btable")
                : $("#contracts");

            $btable.find("tr.jqgroup").each(function () {
                var $icon = $("span.ui-icon", this);
                var isCollapsed = $icon.hasClass("ui-icon-circlesmall-plus");   // ë‹«í˜(+ ì•„ì´ì½˜)
                var isExpanded = $icon.hasClass("ui-icon-circlesmall-minus");  // ì—´ë¦¼(- ì•„ì´ì½˜)

                if (expand && isCollapsed) {
                    $icon.trigger("click");     // ëª¨ë‘ í¼ì¹˜ê¸°: ë‹«íŒ ê²ƒë§Œ í´ë¦­
                } else if (!expand && isExpanded) {
                    $icon.trigger("click");     // ëª¨ë‘ ì ‘ê¸°: ì—´ë¦° ê²ƒë§Œ í´ë¦­
                }
            });
        }
        //í‰ê·  ê°’ êµ¬í•˜ê¸° 
        function calcAvg(contracts, field) {
            const nums = contracts.map(c => Number(c[field])).filter(n => Number.isFinite(n));
            if (!nums.length) return null;
            return nums.reduce((a, b) => a + b, 0) / nums.length;
        }
        // í™”ë©´ ë§ì¶¤
        function resizeMainGrid() {
            var $grid = $("#contracts"); if ($grid.length === 0) return;
            var top = $grid.offset().top || 0, vh = $(window).height() || 0, bottom = 30;
            $grid.jqGrid("setGridHeight", Math.max(200, vh - top - bottom));
            var newW = $grid.closest(".ui-jqgrid").parent().width(); if (newW) $grid.jqGrid("setGridWidth", newW);
        }

        // ìƒì„¸(Products / Promotions) ë Œë”
        function renderProductsHTML(products) {
            var html = '<div class="detail-wrap"><p class="detail-title">Products ìƒì„¸</p>' +
                '<table class="detail-table"><thead><tr>' +
                '<th>Product Id</th><th>ì œí’ˆêµ°</th><th>ìˆ˜ëŸ‰</th><th>ê¸°ì¤€ë‹¨ê°€</th><th>ì‹¤ë‹¨ê°€</th><th>ì˜µì…˜</th><th>ë¼ì¸í•©ê³„</th>' +
                '</tr></thead><tbody>';
            for (var i = 0; i < products.length; i++) {
                var p = products[i] || {}, qty = Number(p.quantity || 0), unit = Number(p.totalPrice || 0);
                var opt = ($.isArray(p.option) && p.option[0] && p.option[0].hasOption) ? ("+" + fmt(p.option[0].optionExtraTotal) + "/ea") : "";
                html += '<tr>' +
                    '<td>' + (p.id || "") + '</td>' +
                    '<td>' + (p.family || "") + '</td>' +
                    '<td>' + fmt(qty) + '</td>' +
                    '<td>' + fmt(p.unitPrice) + '</td>' +
                    '<td>' + fmt(unit) + '</td>' +
                    '<td style="text-align:left">' + opt + '</td>' +
                    '<td>' + fmt(qty * unit) + '</td>' +
                    '</tr>';
            }
            html += '</tbody></table></div>'; return html;
        }
        function renderPromotionsHTML(promotions) {
            var html = '<div class="detail-wrap"><p class="detail-title">Promotions ìƒì„¸</p>' +
                '<table class="detail-table"><thead><tr>' +
                '<th>Promotion Id</th><th>í”„ë¡œëª¨ì…˜ëª…</th><th>ê¸ˆì•¡</th><th>ì¶œì²˜</th>' +
                '</tr></thead><tbody>';
            for (var j = 0; j < promotions.length; j++) {
                var pr = promotions[j] || {};
                html += '<tr>' +
                    '<td>' + (pr.id || "") + '</td>' +
                    '<td>' + (pr.promotionName || "") + '</td>' +
                    '<td>' + fmt(pr.totalAmount) + '</td>' +
                    '<td style="text-transform:capitalize">' + (pr._source || "") + '</td>' +
                    '</tr>';
            }
            html += '</tbody></table></div>'; return html;
        }
        function toggleDetailRow(rowid, dataset, type) {
            var $grid = $("#contracts");
            var $mainTr = $("#" + rowid, $grid[0].grid && $grid[0].grid.bDiv);
            if ($mainTr.length === 0) { $mainTr = $("#" + $.jgrid.jqID(rowid)); }
            var cls = (type === 'products') ? 'detail-row-products' : 'detail-row-promotions';
            var $nextSame = $mainTr.next("." + cls);
            if ($nextSame.length) { $nextSame.remove(); return; }
            var raw = null; for (var i = 0; i < dataset.length; i++) { if (dataset[i].id === rowid) { raw = dataset[i]; break; } }
            var colspan = $mainTr.children("td:visible").length;
            var inner = (type === 'products') ? renderProductsHTML(raw.products || []) : renderPromotionsHTML(raw.promotions || []);
            $('<tr class="' + cls + '"><td colspan="' + colspan + '">' + inner + '</td></tr>').insertAfter($mainTr);
        }

        function isSelectedMonth(isoDateStr) {
            if (!isoDateStr) return false;

            // í™”ë©´ì—ì„œ ì„ íƒëœ YYYY-MM ê°’
            var selectedYm = $("#month").val(); // ì˜ˆ: "2025-09"
            if (!selectedYm) return false;

            // isoDateStr ì• 7ìë¦¬ë§Œ ì¶”ì¶œ ("2025-09")
            var recordYm = isoDateStr.substring(0, 7);

            return recordYm === selectedYm;
        }
        // jqGrid ìƒì„±
        function buildGrid(contracts, initialGroupField) {

            if ($("#contracts")[0].grid) { $("#contracts").GridUnload(); }

            for (var i = 0; i < contracts.length; i++) {
                var c = contracts[i] || {};
                c.opportunity = c.opportunity || {};

                c.leadCreatedDate = c.lead?.createdDate || '';
                c.leadCompany = c.lead?.company || '';
                c.leadSource = c.lead?.leadSource || '';
                c.leadUtm = c.lead?.utm || '';
                c.leadUtmSource = c.lead?.utmSource || '';
                c.leadUtmContent = c.lead?.utmContent || '';
                c.leadUtmTerm = c.lead?.utmTerm || '';
                c.opportunityLeadSource = c.leadSourceOpportunity || c.opportunity.leadSource || '';
                c.fmSido = c.fmSido || c.opportunity.fmSido || '';
                c.fmSigugun = c.fmSigugun || c.opportunity.fmSigugun || '';
                c.fmStoreType = c.fmStoreType || c.opportunity.fmStoreType || '';
                c.plIndustryFirst = c.plIndustryFirst || c.opportunity.plIndustryFirst || '';
                c.plIndustrySecond = c.plIndustrySecond || c.opportunity.plIndustrySecond || '';
                c.typeOfBusiness = c.typeOfBusiness || c.opportunity.typeOfBusiness || '';
                c.recordTypeName = c.recordTypeName || '(ì•Œ ìˆ˜ ì—†ìŒ)';
                c.stageNameFlat = (c.opportunity && c.opportunity.stageName) || '';
                // ë¦¬ë“œâ†’ê¸°íšŒ ì†Œìš”ì¼(ê°ì²´ â†’ ìˆ«ì/ì‚¬ìœ )
                c.leadToOpportunityDays = (c.leadToOpportunity && Number.isFinite(c.leadToOpportunity.days)) ? c.leadToOpportunity.days : null;
                c.leadToOpportunityReason = c.leadToOpportunity ? c.leadToOpportunity.reason : null;

                c.opportunityCreatedDate = c.opportunity.createdDate || '';
                // ë„-ì„¸ì´í”„ ê¸°ë³¸ê°’ë“¤
                c.name = c.name || '';
                c.FieldUser = c.FieldUser || '';
                c.BOUser = c.BOUser || '';
                c.opportunityAccountName = c.opportunity.accountName || '';
                c.opportunityAccountBranchName = c.opportunity.accountBranchName || '';
                c.accountName = c.accountName || '';
                c.accountBranchName = c.accountBranchName || '';
                c.ownerNameFlat = c.opportunity.ownerName || '';
                c.ownerDeptFlat = c.opportunity.ownerDepartment || '';

                c.contractDateStart = c.contractDateStart || '';
                c.contractDateEnd = c.contractDateEnd || '';
                c.contractStatus = c.contractStatus || '';

                // ìˆ«ì ê¸°ë³¸ê°’
                c.TotalNumberofEveryTablet__c = Number(c.TotalNumberofEveryTablet__c || 0);
                c.productsTotal = Number(c.productsTotal || 0);
                c.promotionsFromProductsTotal = Number(c.promotionsFromProductsTotal || 0);
                c.purchaseAmount = Number(c.purchaseAmount || 0);
                c.vat = Number(c.vat || 0);
                c.totalWithVat = Number(c.totalWithVat || 0);
                c.totalDiscount = Number(c.totalDiscount || 0);

                // ë°°ì—´ ê¸°ë³¸ê°’
                c.products = Array.isArray(c.products) ? c.products : [];
                c.promotions = Array.isArray(c.promotions) ? c.promotions : [];


                c.leadTimeDays = (c.leadTime && Number.isFinite(c.leadTime.days)) ? c.leadTime.days : null;
                c.leadTimeReason = c.leadTime ? c.leadTime.reason : null;

                c.prevToFirstCloseDays = (c.prevToFirstClose && Number.isFinite(c.prevToFirstClose.days))
                    ? c.prevToFirstClose.days
                    : null;

                c.prevToFirstCloseReason = c.prevToFirstClose
                    ? c.prevToFirstClose.reason
                    : null;

            }

            // ë¼ë²¨ ë§µ (ê·¸ë£¹ í…ìŠ¤íŠ¸ì— ì‚¬ìš©)
            var labelMap = {
                ownerNameFlat: "ë‹´ë‹¹ì",
                FieldUser: "í•„ë“œë‹´ë‹¹ì",
                BOUser: "BO ë‹´ë‹¹ì",
                ownerDeptFlat: "ë¶€ì„œ",
                recordTypeName: "ë ˆì½”ë“œ íƒ€ì…"
            };
            var groupField = initialGroupField || "ownerNameFlat";

            const leadToOppAvg = calcAvg(contracts, "leadToOpportunityDays");

            const leadTimeAvg = calcAvg(contracts, "leadTimeDays");
            const installAvg = calcAvg(contracts, "prevToFirstCloseDays");
            $("#contracts").jqGrid({
                datatype: "local",
                data: contracts,
                colNames: [
                    "d", "Opp ìƒì„±ì¼(ì›ë³¸)", "Contract Id", "ë¦¬ë“œ Company", "ë¦¬ë“œ ì†ŒìŠ¤", "ë¦¬ë“œ UTM", "UTM Source", "UTM Content", "UTM Term", "ê¸°íšŒ ê³ ê°ëª…", "ê¸°íšŒ ì§€ì ëª…", "ì—…ì¢…(ëŒ€)", "ì—…ì¢…(ì¤‘)", "ì—…íƒœ", "ê¸°íšŒ ë¦¬ë“œ ì†ŒìŠ¤", "ì‹œ/ë„", "ì‹œ/êµ°/êµ¬", "ë§¤ì¥ ìœ í˜•", "ë¦¬ë“œâ†’ê¸°íšŒ(ì¼)", "ê³„ì•½ ì†Œìš”ì¼", "ì„¤ì¹˜ í™•ì • ì†Œìš”ì¼","ë ˆì½”ë“œìœ í˜•", "í•„ë“œë‹´ë‹¹ì", "BO ë‹´ë‹¹ì", "ìƒí˜¸ëª…", "ì§€ì ëª…", "ìƒíƒœ",
                    "ê³„ì•½ì‹œì‘ì¼", "ê³„ì•½ì¢…ë£Œì¼", "ë‹´ë‹¹ì", "ê³„ì•½íƒœë¸”ë¦¿ìˆ˜",
                    "ìƒí’ˆí•©ê³„", "ìƒí’ˆí• ì¸í•©ê³„", "êµ¬ë§¤ê°€", "ë¶€ê°€ì„¸", "í•©ê³„(ë¶€ê°€ì„¸í¬í•¨)",
                    "ë„¤ì´í‹°ë¸Œí”„ë¡œëª¨ì…˜", "ì´í• ì¸",
                    "ë¶€ì„œ" // ìˆ¨ê¹€
                ],
                colModel: [
                    { name: "stageNameFlat", hidden: true },
                    { name: "opportunityCreatedDate", hidden: true },
                    { name: "id", width: 130, key: true, hidden: true },
                    { name: "leadCompany", width: 80 },

                    // LeadSource
                    { name: "leadSource", width: 80, align: "center" },
                    { name: "leadUtm", width: 110, align: "center" },
                    { name: "leadUtmSource", width: 110, align: "center" },
                    { name: "leadUtmContent", width: 140, align: "center" },
                    { name: "leadUtmTerm", width: 120, align: "center" },
                    { name: "opportunityAccountName", width: 120, align: "center" },
                    { name: "opportunityAccountBranchName", width: 110, align: "center" },
                    { name: "plIndustryFirst", width: 100, align: "center" },
                    { name: "plIndustrySecond", width: 110, align: "center" },
                    { name: "typeOfBusiness", width: 90, align: "center" },
                    { name: "opportunityLeadSource", width: 100, align: "center" },
                    { name: "fmSido", width: 80, align: "center" },
                    { name: "fmSigugun", width: 90, align: "center" },
                    { name: "fmStoreType", width: 100, align: "center" },

                    // ë¦¬ë“œâ†’ê¸°íšŒ ì†Œìš”ì¼ (í‰ê·  ëŒ€ë¹„ ìƒ‰ìƒ)
                    {
                        name: "leadToOpportunityDays", width: 80, align: "right", sorttype: "number",
                        formatter: function (cell, opts, row) {
                            if (Number.isFinite(cell)) {
                                // í‰ê·  ëŒ€ë¹„ ìƒ‰ìƒ (ì‘ì„ìˆ˜ë¡ ë¹ ë¦„ â†’ íŒŒë‘, í´ìˆ˜ë¡ ëŠë¦¼ â†’ ë¹¨ê°•)
                                var color = "";
                                if (leadToOppAvg != null) {
                                    if (cell > leadToOppAvg) color = "red";
                                    else if (cell < leadToOppAvg) color = "blue";
                                }
                                // reasonì´ okë©´ ìˆ«ì, ì•„ë‹ˆë©´ ê¸°í˜¸
                                return '<span title="í‰ê· : ' + (leadToOppAvg?.toFixed?.(1) ?? '-') + '" style="color:' + color + '">' +
                                    cell.toLocaleString() + '</span>';
                            }
                            if (row.leadToOpportunityReason === "missing-date") return '<span title="ë‚ ì§œ ì—†ìŒ">â€”</span>';
                            if (row.leadToOpportunityReason === "parse-error") return '<span title="íŒŒì‹± ì˜¤ë¥˜">!</span>';
                            return "";
                        },
                        summaryType: "avg" // í‰ê·  ìš”ì•½(ë²„ì „ì— ë”°ë¼ ë™ì‘). í•„ìš”ì‹œ ì»¤ìŠ¤í…€ avgë¡œ êµì²´ ê°€ëŠ¥
                    },
                    {
                        name: "leadTimeDays", width: 80, align: "right", sorttype: "number",

                        formatter: function (cell, opts, row) {
                            if (row.leadTimeReason === "missing-date") return '<span title="ë‚ ì§œ ì—†ìŒ">ë‚ ì§œ ì—†ìŒ</span>';
                            if (row.leadTimeReason === "parse-error") return '<span title="ë‚ ì§œ íŒŒì‹± ì˜¤ë¥˜">!</span>';
                            if (!Number.isFinite(cell)) return "";
                            let color = "";

                            if (leadTimeAvg != null) {
                                if (cell > leadTimeAvg) color = "red";      // í‰ê· ë³´ë‹¤ í¬ë©´ ë¹¨ê°•
                                else if (cell < leadTimeAvg) color = "blue"; // í‰ê· ë³´ë‹¤ ì‘ìœ¼ë©´ íŒŒë‘
                            }
                            return `<span style="color:${color}">${cell.toLocaleString()}</span>`;
                        },
                        summaryType: "avg"
                    },
                    {
                        name: "prevToFirstCloseDays", width: 80, align: "right", sorttype: "number",
                        formatter: function (cell, opts, row) {
                            if (row.prevToFirstCloseReason === "missing-date") return '<span title="ë‚ ì§œ ì—†ìŒ">ë‚ ì§œ ì—†ìŒ</span>';
                            if (row.prevToFirstCloseReason === "parse-error") return '<span title="ë‚ ì§œ íŒŒì‹± ì˜¤ë¥˜">!</span>';
                            if (!Number.isFinite(cell)) return "";
                            let color = "";
                            if (installAvg != null) {
                                if (cell > installAvg) color = "red";
                                else if (cell < installAvg) color = "blue";
                            }
                            return `<span style="color:${color}">${cell.toLocaleString()}</span>`;
                        },
                        summaryType: "avg"
                    },
                    { name: "recordTypeName", label: "ë ˆì½”ë“œ íƒ€ì…", width: 140, align: "center" },
                    { name: "FieldUser", width: 80, align: "center" },
                    { name: "BOUser", width: 80, align: "center" },
                    { name: "accountName", width: 100, align: "center" },
                    { name: "accountBranchName", width: 80, align: "center" },
                    { name: "contractStatus", width: 110, align: "center" },
                    { name: "contractDateStart", width: 100, align: "center" },
                    { name: "contractDateEnd", width: 100, align: "center" },
                    { name: "ownerNameFlat", width: 80, align: "center" },

                    {
                        name: "TotalNumberofEveryTablet__c",
                        width: 110,
                        align: "right",
                        formatter: "number",
                        formatoptions: { thousandsSeparator: ",", decimalPlaces: 0 },
                        summaryType: "sum",                         // ê·¸ë£¹ í•©ê³„ ê³„ì‚°
                        summaryTpl: "íƒœë¸”ë¦¿ í•©ê³„: {0}",             // ê·¸ë£¹ í—¤ë”ì— í‘œì‹œ
                        classes: "highlight-col"
                    },
                    {
                        name: "productsTotal", width: 120, align: "right",
                        formatter: function (cell, opts, row) {
                            var val = fmt(cell);
                            return '<a href="#" class="clickable prod-toggle" data-rowid="' + (row.id || opts.rowId) + '">' + val + '</a>';
                        },
                        summaryType: "sum"
                    },
                    {
                        name: "promotionsFromProductsTotal", width: 130, align: "right",
                        formatter: "number", formatoptions: { thousandsSeparator: ",", decimalPlaces: 0 }, summaryType: "sum"
                    },
                    {
                        name: "purchaseAmount", width: 130, align: "right",
                        formatter: "number", formatoptions: { thousandsSeparator: ",", decimalPlaces: 0 }, summaryType: "sum"
                    },
                    {
                        name: "vat", width: 90, align: "right",
                        formatter: "number", formatoptions: { thousandsSeparator: ",", decimalPlaces: 0 }, summaryType: "sum"
                    },
                    {
                        name: "totalWithVat", width: 120, align: "right",
                        formatter: "number", formatoptions: { thousandsSeparator: ",", decimalPlaces: 0 }, summaryType: "sum",
                        classes: "highlight2-col"
                    },
                    {
                        name: "promotionsNativeTotal", width: 120, align: "right",
                        formatter: "number", formatoptions: { thousandsSeparator: ",", decimalPlaces: 0 }, summaryType: "sum"
                    },
                    {
                        name: "totalDiscount", width: 120, align: "right",
                        formatter: function (cell, opts, row) {
                            var val = fmt(cell);
                            return '<a href="#" class="clickable promo-toggle" data-rowid="' + (row.id || opts.rowId) + '">' + val + '</a>';
                        },
                        summaryType: "sum"
                    },

                    { name: "ownerDeptFlat", hidden: true }
                ],
                loadComplete: function () {
                    const $grid = $("#contracts");
                    const ids = $grid.jqGrid('getDataIDs');

                    function norm(s) { return String(s || '').toLowerCase().replace(/\s+/g, ''); }
                    const closedWonSet = new Set(['closedwon', 'ê³„ì•½ì™„ë£Œ', 'ê³„ì•½ ì™„ë£Œ'].map(norm));

                    for (let i = 0; i < ids.length; i++) {
                        const id = ids[i];
                        const stage = $grid.jqGrid('getCell', id, 'stageNameFlat');
                        const createdDate = $grid.jqGrid('getCell', id, 'opportunityCreatedDate');

                        if (!closedWonSet.has(norm(stage))) {
                            $("#" + $.jgrid.jqID(id)).addClass("row-not-closed");
                        }
                        if (!isSelectedMonth(createdDate)) {
                            $("#" + $.jgrid.jqID(id)).addClass("row-not-current-month");
                        }
                    }
                    const totalTablets = $grid.jqGrid('getCol', 'TotalNumberofEveryTablet__c', false, 'sum');
                    $grid.jqGrid('footerData', 'set', {
                        ownerNameFlat: 'ì´ í•©ê³„',
                        TotalNumberofEveryTablet__c: totalTablets
                    });
                },
                pager: "#contracts-pager",
                rowNum: 1000, rowList: [20, 50, 1000],
                viewrecords: true, autowidth: true, shrinkToFit: false, height: 400,

                grouping: true,
                groupingView: {
                    groupField: [groupField],
                    groupColumnShow: [true],
                    groupText: [labelMap[groupField] + ": <b>{0}</b> <span style='color:#888'>( {1} ê±´ )</span>"],
                    groupOrder: ["asc"],
                    groupSummary: [true],
                    groupSummaryPos: ["footer"]
                },

                subGrid: false,
                footerrow: true,
                userDataOnFooter: true
            });

            $("#contracts").jqGrid('setGroupHeaders', {
                useColSpanStyle: true,
                groupHeaders: [
                    { startColumnName: "leadCompany", numberOfColumns: 6, titleText: "<span>ë¦¬ë“œ ì •ë³´</span>" },
                    { startColumnName: "opportunityAccountName", numberOfColumns: 5, titleText: "<span>ê³ ê° ì •ë³´</span>" },
                    { startColumnName: "opportunityLeadSource", numberOfColumns: 10, titleText: "<span>ì˜ì—… ê¸°íšŒ ì •ë³´</span>" },
                    { startColumnName: "accountName", numberOfColumns: 14, titleText: "<span>ê³„ì•½ ì •ë³´</span>" }
                ]
            });

            // ìƒì„¸ í† ê¸€ í•¸ë“¤ëŸ¬ ìœ ì§€
            $("#contracts").off("click", ".prod-toggle").on("click", ".prod-toggle", function (e) {
                e.preventDefault(); toggleDetailRow($(this).data("rowid"), contracts, 'products');
            });
            $("#contracts").off("click", ".promo-toggle").on("click", ".promo-toggle", function (e) {
                e.preventDefault(); toggleDetailRow($(this).data("rowid"), contracts, 'promotions');
            });

            resizeMainGrid();
        }
        $("#expandGroupsBtn").on("click", function () { toggleAllGroups(true); });
        $("#collapseGroupsBtn").on("click", function () { toggleAllGroups(false); });
        // ë°ì´í„° ë¡œë“œ
        function loadContracts() {
            var ym = $("#month").val();                 // YYYY-MM
            var dept = $("#ownerDept").val();           // ë¶€ì„œ
            $("#title").text("ì¡°íšŒ: " + labelKorean(ym) + (dept ? (" / " + dept) : ""));

            var params = { month: ym };
            if (dept) params.ownerDept = dept;

            $.getJSON(API_BASE + "/contracts", params, function (contracts) {
                buildGrid(contracts);
            }).fail(function (xhr) {
                alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: " + (xhr && xhr.status));
            });
        }

        // ì´ˆê¸° ì…‹ì—…
        $(function () {
            // ê¸°ë³¸ ì›”: ì˜¤ëŠ˜ ê¸°ì¤€ ì§€ë‚œë‹¬
            var d = new Date(); d.setDate(1); d.setMonth(d.getMonth());
            var ym = d.toISOString().slice(0, 7);
            $("#month").val(ym);


            // í•¸ë“¤ëŸ¬
            $("#loadBtn").on("click", loadContracts);
            $("#prevBtn").on("click", function () {
                $("#month").val(addMonths($("#month").val(), -1)); loadContracts();
            });
            $("#nextBtn").on("click", function () {
                $("#month").val(addMonths($("#month").val(), +1)); loadContracts();
            });
            $("#ownerDept").on("change", loadContracts);
            $("#month").on("change", loadContracts);

            var labelMap = {
                ownerNameFlat: "ë‹´ë‹¹ì",
                FieldUser: "í•„ë“œë‹´ë‹¹ì",
                BOUser: "BO ë‹´ë‹¹ì",
                ownerDeptFlat: "ë¶€ì„œ"
            };

            // ê¸°ë³¸ ê·¸ë£¹ì€ 'ë‹´ë‹¹ì'
            $("#groupBy").val("ownerNameFlat");

            // ê·¸ë£¹ ê¸°ì¤€ ë³€ê²½ ì‹œ ì¦‰ì‹œ ë°˜ì˜
            $("#groupBy").on("change", function () {
                var field = $(this).val();
                $("#contracts").jqGrid('groupingGroupBy', field, {
                    groupText: [labelMap[field] + ": <b>{0}</b> <span style=\"color:#888\">( {1} ê±´ )</span>"],
                    groupOrder: ["asc"],
                    groupColumnShow: [true],
                    groupSummary: [true],
                    groupSummaryPos: ["footer"]
                });
            });
            // ìµœì´ˆ ë¡œë“œ
            loadContracts();

            // ë¦¬ì‚¬ì´ì¦ˆ
            $(window).on("resize.jqGrid", resizeMainGrid);
        });
    </script>
</body>

</html>
